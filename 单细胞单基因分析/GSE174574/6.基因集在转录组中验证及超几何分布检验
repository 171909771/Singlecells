library(mHG)
options(digits = 10)

## 处理转录组数据集
if(F){
  ## 方法1
library(limma)
library(edgeR)
## 读取数据并转换一直的变量，改变dat1名称
dat=read.delim("GSE77986_series_matrix.txt.gz",header = T,comment.char = "!")
# library(devtools)
# install_github("jmzeng1314/AnnoProbe")
library(AnnoProbe)
gpl='GPL16570'
## 可以更换type信息，具体查看?idmap
probe2gene=idmap(gpl,type = 'soft', mirror = "tercent")
head(probe2gene)

## 方法2
## 下载soft，用shell
cat GPL22598_family.soft|grep -v '^!\|^#\|^\^' >annotation

# 整理数据
dat1=merge(dat,probe2gene,by.x="ID_REF",by.y="ID")
dat <- aggregate(x = dat1[,2:(length(dat1)-1)],
                 by = list(dat1$symbol),
                 FUN = mean)
rownames(dat)=dat$Group.1
dat$Group.1=NULL


library(AnnoProbe) 
ids=annoGene( rownames(dat),'SYMBOL','mouse')
procongene=ids$SYMBOL[ids$biotypes=='protein_coding']
dat=dat[rownames(dat)%in%procongene,]

## 看是否标准化
boxplot(dat)
### 如果需要
dat=log2(dat)
dat=data.frame(normalizeBetweenArrays(dat))


colnames(dat)=c("WT_sham_rep1","WT_sham_rep2","WT_sham_rep3","Clec4e-/-_sham_rep1","Clec4e-/-_sham_rep2","Clec4e-/-_sham_rep3","WT_IR_rep1","WT_IR_rep2","WT_IR_rep3","WT_IR_rep4","WT_IR_rep5","Clec4e-/-_IR_rep1","Clec4e-/-_IR_rep2","Clec4e-/-_IR_rep3","Clec4e-/-_IR_rep4","Clec4e-/-_IR_rep5")
dat6=dat[grepl("WT",colnames(dat))]


saveRDS(dat6,file = 'GSE77986.rds')
}

p2bulk=readRDS('GSE77986.rds')
## 得到singlecell基因集
# 得到sham数据集
dat1=p2bulk[1:3]
# 得到MCAO数据集
dat2=p2bulk[4:8]

## 输入MCAO，sham数据及x基因，获得x基因的person相关排序基因集（已经用加法把不同数据集的相关系数相加）
## 得到的list中的基因是排序后的基因
blkg=function(dat1,dat2,x){
  tmp1=data.frame(value=t(cor(as.numeric(dat1[x,]),t(dat1))))
  tmp2=data.frame(value=t(cor(as.numeric(dat2[x,]),t(dat2))))
  tmp1$absvalue=abs(tmp1$value)
  tmp1$genenames=rownames(tmp1)
  tmp2$absvalue=abs(tmp2$value)
  tmp2$genenames=rownames(tmp2)
  
  
  tmp3=merge(tmp1,tmp2,by='genenames',suffixes =c('.sham','.mcao'))
  tmp3$comcor=tmp3$absvalue.sham+tmp3$absvalue.mcao
  tmp3=tmp3[order(tmp3$comcor,decreasing = T),]
  return(list(data=tmp3,gene=tmp3$genenames))
}

## 按不同bulk基因p的比例，与单细胞集top n进行超几何分析
minhgeo=function(bulkgene,singlegene,p,n){
  bulkgene.p=bulkgene[1:round(length(bulkgene)*p*0.01)]
  singlegene.n=head(singlegene,n)
  tmp= bulkgene.p %in% singlegene.n
  result <- mHG.test(tmp)[["p.value"]]
  cat(result)
  return(result)}


## 应用
wcl=blkg(dat1,dat2,'P2ry12')
singlegene=genemicro  #这个是单细胞的排序基因集
bulkgene=wcl$gene  # 转录组的排序基因集
## 关键步骤，统计
test=minhgeo(bulkgene,singlegene,40,150)
