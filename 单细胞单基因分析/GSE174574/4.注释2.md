```r
library(tidyverse)
library(Seurat)
library(patchwork)
# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释
levels(annotation1@meta.data$panglao)[grep('Dendritic cells|Macrophages|Monocytes|Red pulp macrophages|Plasmacytoid dendritic cells',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$panglao))]='monocyte-derived cells'


levels(annotation1@meta.data$panglao)[grep('Smooth muscle cells|Pericytes|Fibroblasts',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='Perivascular cells'



levels(annotation1@meta.data$panglao)[grep('NK cells|T cells|Natural killer T cells|T follicular helper cells|Gamma delta T cells|Plasma cells|B cells|T regulatory cells|T helper cells',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='Lymphocytes'


levels(annotation1@meta.data$panglao)[grep('Basophils|Eosinophils',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='Granulocytes'

levels(annotation1@meta.data$panglao)[grep('Interneurons|Adrenergic neurons|Dopaminergic neurons|Trigeminal neurons|Pyramidal cells|Cholinergic neurons|Purkinje neurons|Cajal-Retzius cells',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='Neurons'


levels(annotation1@meta.data$panglao)[grep('Neural stem/precursor cells|Immature neurons',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='neural progenitor cells'

levels(annotation1@meta.data$panglao)[grep('Tanycytes',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$panglao))]='Ependymal cells'
# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释# 修改panglao的注释





# 修改scinamarker的注释 #修改scinamarker的注释# 修改scinamarker的注释 # 修改scinamarker的注释 # 修改scinamarker的注释 # 修改scinamarker的注释 
levels(annotation1@meta.data$scinamarker)[grep('Natural killer cell|B cell|T cell|CD8+ T cell|CD4+ T cell',
                                           ignore.case = T,
                                           levels(annotation1@meta.data$scinamarker))]='Lymphocytes'

levels(annotation1@meta.data$scinamarker)[grep('Ependymal cell|Tanycyte',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Ependymal cells'

levels(annotation1@meta.data$scinamarker)[grep('Microglial cell|Disease-associated microglial cell',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Microglia'

levels(annotation1@meta.data$scinamarker)[grep('Oligodendrocyte',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Oligodendrocytes'

levels(annotation1@meta.data$scinamarker)[grep('Astrocyte',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Astrocytes'

levels(annotation1@meta.data$scinamarker)[grep('Smooth muscle cell|Mural cell|Pericyte|Fibroblast',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Perivascular cells'

levels(annotation1@meta.data$scinamarker)[grep('Macrophage|Dendritic cell|Monocyte|Border-associated macrophage|
                                               Engrafted macrophage|Infiltrating macrophage|Monocyte-derived macrophage',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='monocyte-derived cells'

levels(annotation1@meta.data$scinamarker)[grep('Choroid plexus cell',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Choroid plexus cells'

levels(annotation1@meta.data$scinamarker)[grep('Neutrophil',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Granulocytes'

levels(annotation1@meta.data$scinamarker)[grep('Long-projecting GABAergic cell|D1 Medium spiny neuron(D1 MSN)|CCK basket cell|
                                               Type IC spiral ganglion neuron|Glutamatergic neuron|Excitatory neuron
                                               |Martinotti cell|Pyramidal cell|Inhibitory neuron
                                               |Neurogliaform cell|Upper layer 2 cell|Interneuron|Type IA spiral ganglion neuron|
                                               Type II spiral ganglion neuron|Neuron|Pan-neuronal cell|Basket cell|
                                               Type IB spiral ganglion neuron|Chandelier cell|Layer neuron|
                                               GABAergic neuron|Cajal-Retzius cell',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Neurons'

levels(annotation1@meta.data$scinamarker)[grep('Neuroblast|Activated neural stem cell|Neural progenitor cell|Neural stem cell|
                                               Stem cell',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='neural progenitor cells'

levels(annotation1@meta.data$scinamarker)[grep('Neutrophil',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Granular cells'

levels(annotation1@meta.data$scinamarker)[grep('Endothelial cell',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$scinamarker))]='Endothelial cells'






# 修改tmp的注释# 修改tmp的注释# 修改tmp的注释# 修改tmp的注释# 修改tmp的注释# 修改tmp的注释
levels(annotation1@meta.data$tmp)[grep('Macrophages|Dendritic cells',
                                               ignore.case = T,
                                               levels(annotation1@meta.data$tmp))]='monocyte-derived cells'

levels(annotation1@meta.data$tmp)[grep('qNSCs|aNSCs|NPCs',
                                       ignore.case = T,
                                       levels(annotation1@meta.data$tmp))]='neural progenitor cells'


levels(annotation1@meta.data$tmp)[grep('Fibroblasts|Cardiomyocytes|Fibroblasts activated',
                                       ignore.case = T,
                                       levels(annotation1@meta.data$tmp))]='Perivascular cells'



levels(annotation1@meta.data$tmp)[grep('Ependymal',
                                       ignore.case = T,
                                       levels(annotation1@meta.data$tmp))]='Ependymal cells'

levels(annotation1@meta.data$tmp)[grep('NK cells',
                                       ignore.case = T,
                                       levels(annotation1@meta.data$tmp))]='Lymphocytes'

levels(annotation1@meta.data$tmp)[grep('NK cells',
                                       ignore.case = T,
                                       levels(annotation1@meta.data$tmp))]='Lymphocytes'


######################合并data
DimPlot(annotation1, reduction = "tsne", label = T, group.by = 'tmp')
dat.testmerge=data.frame(scina=annotation1@meta.data$scinamarker,panglao=annotation1@meta.data$panglao,
                         tmp=annotation1@meta.data$tmp)

#####统计 相同率
####改，用dunpilicated
dat.testmerge$decision=apply(dat.testmerge, 1, function(x){
  if(x[1]==x[2] | x[1]==x[3] |x[2]==x[3]){
    x[4]=TRUE
  }else{
    x[4]=FALSE
  }})

##############重新确定细胞群

annotation2=annotation1[,dat.testmerge$decision]

DimPlot(annotation2, reduction = "tsne", label = T, group.by = 'scinamarker')


dat.testmerge1=data.frame(scina=annotation2@meta.data$scinamarker,
                         panglao=annotation2@meta.data$panglao,
                         tmp=annotation2@meta.data$tmp)



dat.testmerge1$repli=apply(dat.testmerge1,1,function(x){
  if(x[1]==x[2] | x[1]==x[3]){
    x[4]=x[1]
  } 
  else if(x[2]==x[3]){
    x[4]=x[2]
  }
})

ref=table(dat.testmerge1$repli)>50

dat.testmerge1$ref=dat.testmerge1$repli!='neural progenitor cells'

annotation2=annotation2[,dat.testmerge1$ref]

dat.testmerge1=data.frame(scina=annotation2@meta.data$scinamarker,
                          panglao=annotation2@meta.data$panglao,
                          tmp=annotation2@meta.data$tmp)

dat.testmerge1$repli=apply(dat.testmerge1,1,function(x){
  if(x[1]==x[2] | x[1]==x[3]){
    x[4]=x[1]
  } 
  else if(x[2]==x[3]){
    x[4]=x[2]
  }
})

ref=as.factor(dat.testmerge1$repli)
annotation2@meta.data[["finalcluster"]]=ref
DimPlot(annotation2, reduction = "tsne", label = T, group.by = 'finalcluster')
saveRDS(annotation2,file = 'annotation2.finalcluster.rds')
```
