library("lmPerm")
p2gene <- read_rds('downstream analysis/p2_for_micrglia_0.6.rds')
p2gene_wcl <- subset(p2gene,value.MCAO>0.74 & value.Sham>0.74)

dat1 <- read.delim('gse28731_GSE58720_GSE32529_GSE23163_merge/result_exp.txt')
rownames(dat1) <- dat1$X
dat1$X <- NULL
colnames(dat1) <- str_split(colnames(dat1) ,"GSE",simplify = T)[,1]

dat1 <- dat1[p2gene_wcl$genenames,]
dat1 <- na.omit(dat1)



dat <- apply(dat1,2, mean)
dat <- data.frame(name=colnames(dat1),value=dat)
dat_sham <- dat$value[1:13]
dat_mcao <-dat$value[14:27]


## 74个基因参与评估
# T检验，最后用Welch T检验，因为方差不齐
## 正态性检验
qqnorm(dat$value, pch = 1, frame = FALSE)
qqline(dat$value, col = "steelblue", lwd = 2)
shapiro.test(dat_sham)
shapiro.test(dat_mcao)
var.test(dat_sham,dat_mcao)

t.test(dat_sham,dat_mcao)



## 置换检验
summary(lmp(value~name,data=dat))


library(ggpubr)
library(rstatix)
library(ggplot2)
ggplot(dat,aes(x=name,y=value,fill=name))+
  geom_violin()+geom_boxplot(fill='white',width = 0.2,alpha=0.5)+
  stat_compare_means(method = "t.test",label.x = 0.8, label.y = 18.8)+scale_fill_nejm()+
  theme_bw()+labs(x='Group',y='Microglia P2ry12 score')+
  theme(legend.position = c(0.8,0.2),legend.background = element_rect(fill=alpha('white',0)))
  


