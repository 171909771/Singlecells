library(monocle)

# 转变成monocle
```
### 改变microglia.cells
input=microglia.cells
sc_cds=as.CellDataSet(input)
```
# 预处理
```
sc_cds <- estimateSizeFactors(sc_cds)
sc_cds <- estimateDispersions(sc_cds)
```
# 确定下游分析的基因,选择其中一个就可以
```
### 1.使用seurat选择的高变基因
input <- FindVariableFeatures(input, selection.method = "vst", nfeatures = 2000)
express_genes <- VariableFeatures(input)
cds <- setOrderingFilter(cds, express_genes) 
plot_ordering_genes(cds)
### 2.使用monocle选择的高变基因
disp_table <- dispersionTable(sc_cds) 
disp.genes <- subset(disp_table, mean_expression >= 0.1 & dispersion_empirical >= 1 * dispersion_fit)$gene_id
cds <- setOrderingFilter(cds, disp.genes)
plot_ordering_genes(cds)
### 3.seurate,单个cluster一般不用, 使用clusters差异表达基因, 
deg.cluster <- FindAllMarkers(pbmc)
express_genes <- subset(deg.cluster,p_val_adj<0.05)$gene
cds <- setOrderingFilter(cds, express_genes) 
plot_ordering_genes(cds) 
```

# 降维，属于轨迹的预处理
```
### 确定PCA中dim的个数，肘拐点
plot_pc_variance_explained(cds, return_all = F)
### 设置n值，肘拐点
n= 6
cds <- reduceDimension(cds, max_components = 2, num_dim = n,method = 'DDRTree') 
cds <- orderCells(cds)
```
# 发育轨迹分析
```
plot_cell_trajectory(cds, color_by = "Pseudotime")
```
![image](https://user-images.githubusercontent.com/41554601/175468933-f0dee1da-33dc-4a31-ac4a-ac84886eb1e8.png)
```
plot_cell_trajectory(cds, color_by = "State")
```
![image](https://user-images.githubusercontent.com/41554601/175468894-e8d7e4db-1878-423b-b5c4-1915205224ed.png)


### 选择基因看单基因情况
```
s.genes <- c("Ptpn6","Glipr1","Rasa1") 
p1 <- plot_genes_jitter(cds[s.genes,], grouping = "State", color_by = "State") 
p2 <- plot_genes_violin(cds[s.genes,], grouping = "State", color_by = "State") 
p3 <- plot_genes_in_pseudotime(cds[s.genes,], color_by = "State")
```
![image](https://user-images.githubusercontent.com/41554601/175469717-a2e4c0f2-514c-47b6-8439-ef2e57922e22.png)
