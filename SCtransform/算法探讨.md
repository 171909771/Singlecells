# step1 用poisson分布拟合（细胞测序深度 和 每个细胞count在每个gene）
### 预处理数据
```
pbmc_data=data.frame(pbmc@assays$RNA@counts) 
cell_attr <- data.frame(n_umi = colSums(pbmc_data), n_gene = colSums(pbmc_data > 
                                                                       0))
cell_attr$logumi=log10(cell_attr$n_umi)
```
##### 得到log10的cell umi值（log（细胞测序深度））, cell_attr 如下：
![image](https://user-images.githubusercontent.com/41554601/184563919-6618f358-2886-4a14-ad37-6039da6a0ebf.png)
##### 按照文章要求，取100个细胞来观察
```
cellnames=sample(colnames(pbmc_data),size = 100)
genenames=rownames(pbmc_data[rowSums(pbmc_data[,cellnames]>0)>5,])
dat1=pbmc_data[genenames,cellnames]   # 取100个细胞对应的dataframe
data_step1 <- cell_attr[cellnames, , drop = FALSE]  # 取100个细胞对应的测序深度
model_str <- paste0('y ~ ', paste("log_umi", collapse = ' + '))  # 构建公式：“y ~ log_umi”
```
### 关键步骤
```
fit=apply(dat1,1, function(y){
  fit <- glm(as.formula(model_str), data = data_step1,family = poisson)  # 广义线性回归拟合poisson
  # fit <-qpois_reg(regressor_data, y, 1e-9, 100, 1.0001, TRUE)  C++加速版本
  fit$theta <- as.numeric(x = suppressWarnings(theta.ml(y = y, mu = fit$fitted))) # 用theta.ml找theta
  return(c(fit$theta,fit$coefficients))
})
fit=t(fit)
colnames(fit)[1] <- 'theta'
```
##### fit如下图所示：
![image](https://user-images.githubusercontent.com/41554601/184565525-5ab00b44-8c59-4e08-87d3-175be7455d0f.png)
#### 可以用get_model_pars函数
```
cells_step1=colnames(dat1)
genes_step1=rownames(dat1)
umi=dat1
bin_size=500
method = 'poisson'
theta_given=NULL
theta_estimation_fun = 'theta.ml'
verbosity = 2
model_pars <- get_model_pars(genes_step1, bin_size, umi, model_str, cells_step1,
                             method, data_step1, theta_given, theta_estimation_fun,
                             verbosity)
```
##### model_pars如下图所示，和fit结果一致
![image](https://user-images.githubusercontent.com/41554601/184566346-2fd1d056-5207-477b-8c38-d87089dceeb9.png)

# step2 平滑处理参数
### 转换theta到dispersion






