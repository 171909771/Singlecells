
先得到seurat数据
----
```
library(Seurat)
library(patchwork)
# 根据分组信息进行车分数据
sce.list <- SplitObject(sce, split.by = "group")
```
开始整合数据
---
#### 对不同list进行标准化，方法1，2需要
```
sce.list <- lapply(X = sce.list, FUN = function(x) {
    x <- NormalizeData(x, verbose = FALSE)
    x <- FindVariableFeatures(x, verbose = FALSE)
  })
```
* 如果想要最后结果里面出现特定基因，在SelectIntegrationFeatures下一行添加如下代码
* features=c(features,"Ripk1", "Ptpn6", "Traf6" )  # "Ripk1", "Ptpn6", "Traf6" 为感兴趣基因
##### 方法1: `rPCA`
##### 速度更快，需要先对数据进行上面的PCA。切满足下面3个使用条件：
* A substantial fraction of cells in one dataset have no matching type in the other 
* Datasets originate from the same platform (i.e. multiple lanes of 10x genomics) 
* There are a large number of datasets or cells to integrate 
```
# 找关键基因
features <- SelectIntegrationFeatures(object.list = sce.list)
# 归一化，并作PCA
sce.list <- lapply(X = sce.list, FUN = function(x) {
    x <- ScaleData(x, features = features, verbose = FALSE)
    x <- RunPCA(x, features = features, verbose = FALSE)
  })
# 找锚点
anchors <- FindIntegrationAnchors(object.list = sce.list, anchor.features = features, reduction = "rpca",
                                    dims = 1:50)  
# 设置锚点，整合完成                                    
sce.integrated <- IntegrateData(anchorset = anchors, dims = 1:50)
```
##### 方法2：CCA。使用条件：跨物种，跨方法学 
- https://satijalab.org/seurat/articles/integration_large_datasets.html
##### 缺点：`速度慢`
```
features <- SelectIntegrationFeatures(object.list = sce.list)
anchors <-  FindIntegrationAnchors(object.list = sce.list, anchor.features = features)
sce.integrated <- IntegrateData(anchorset = anchors, dims = 1:50)
```
##### 方法3：SCTransform + 整合
```
sce.list <- lapply(X = sce.list, FUN = SCTransform, method = "glmGamPoi")
features <- SelectIntegrationFeatures(object.list = sce.list, nfeatures = 3000)
#### 如有特定基因，添加下面代码
# features=c(features,"Ripk1", "Ptpn6", "Traf6")
sce.list <- PrepSCTIntegration(object.list = sce.list, anchor.features = features)
sce.list <- lapply(X = sce.list, FUN = RunPCA, features = features)
anchors <-  FindIntegrationAnchors(object.list = sce.list, normalization.method = "SCT",
                                   anchor.features = features, dims = 1:30, reduction = "rpca", k.anchor = 20)
sce.integrated <-IntegrateData(anchorset = anchors, normalization.method = "SCT", dims = 1:30)
```
       
分群
---
```
sce.integrated <- ScaleData(sce.integrated, verbose = FALSE)
sce.integrated <- RunPCA(sce.integrated, verbose = FALSE)
sce.integrated <- RunUMAP(sce.integrated, dims = 1:50)

immune.combined <- FindNeighbors(sce.integrated, reduction = "pca", dims = 1:30)
immune.combined <- FindClusters(immune.combined, resolution = 0.5)

p1 <- DimPlot(immune.combined, reduction = "umap", group.by = "group")
p2 <- DimPlot(immune.combined, reduction = "umap", label = TRUE, repel = TRUE)
p1 + p2
```

提取特定细胞亚群中的细胞簇分析
---
```
## 提取特定细胞亚群,改下面的群的名字
cluster1="Microglia"
cluster2="Astrocytes"
annotation.cluster1.cluster2=subset(annotation1,celltype==cluster1|celltype==cluster2)
## 加入新的meta注释
test=annotation.microglia.astrocyte
test$tmp <- paste(test@meta.data[["celltype"]], test@meta.data[["seurat_clusters"]], sep = "_")
## 画图1
plots <- VlnPlot(test, features = c("Ripk1", "Ptpn6", "Traf6"), split.by = "celltype.group", group.by = "tmp", 
                 pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 1)
```
![image](https://user-images.githubusercontent.com/41554601/185724730-6c23a2ec-6bde-449c-b659-d684dec9ee22.png)
```
## 画图2
FeaturePlot(test, features = c("Ripk1", "Ptpn6", "Traf6"),split.by = "group", max.cutoff = NA, 
            cols = c("grey", "red"))
```
![image](https://user-images.githubusercontent.com/41554601/185724745-a276a65c-6bc8-46b5-a7d5-9e648f0d5120.png)





